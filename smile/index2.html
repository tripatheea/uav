<!DOCTYPE html>
<html lang="en">
<head>
	<meta content="charset=utf-8">
	<title>Smile</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	
	<style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>
</head>
<body>
	
	
	<div id="map-canvas" style="width: 100%; height: 100%;"></div>
	
	<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>

	
	<script type="text/javascript">
		zoomLevel = 15;
		TILE_SIZE = 35;
		function geo_to_tile(lat, lon) {
				
				
				var chicago = new google.maps.LatLng(lat, lon);
				
				function bound(value, opt_min, opt_max) {
				  if (opt_min != null) value = Math.max(value, opt_min);
				  if (opt_max != null) value = Math.min(value, opt_max);
				  return value;
				}

				function degreesToRadians(deg) {
				  return deg * (Math.PI / 180);
				}

				function radiansToDegrees(rad) {
				  return rad / (Math.PI / 180);
				}
				
				/** @constructor */
				function MercatorProjection() {
				  this.pixelOrigin_ = new google.maps.Point(TILE_SIZE / 2,
					  TILE_SIZE / 2);
				  this.pixelsPerLonDegree_ = TILE_SIZE / 360;
				  this.pixelsPerLonRadian_ = TILE_SIZE / (2 * Math.PI);
				}

				MercatorProjection.prototype.fromLatLngToPoint = function(latLng,
					opt_point) {
				  var me = this;
				  var point = opt_point || new google.maps.Point(0, 0);
				  var origin = me.pixelOrigin_;

				  point.x = origin.x + latLng.lng() * me.pixelsPerLonDegree_;

				  // Truncating to 0.9999 effectively limits latitude to 89.189. This is
				  // about a third of a tile past the edge of the world tile.
				  var siny = bound(Math.sin(degreesToRadians(latLng.lat())), -0.9999,
					  0.9999);
				  point.y = origin.y + 0.5 * Math.log((1 + siny) / (1 - siny)) *
					  -me.pixelsPerLonRadian_;
				  return point;
				};

				MercatorProjection.prototype.fromPointToLatLng = function(point) {
				  var me = this;
				  var origin = me.pixelOrigin_;
				  var lng = (point.x - origin.x) / me.pixelsPerLonDegree_;
				  var latRadians = (point.y - origin.y) / -me.pixelsPerLonRadian_;
				  var lat = radiansToDegrees(2 * Math.atan(Math.exp(latRadians)) -
					  Math.PI / 2);
				  return new google.maps.LatLng(lat, lng);
				};

				function createInfoWindowContent() {
					
				  var numTiles = 1 << zoomLevel;
				  var projection = new MercatorProjection();
				  var worldCoordinate = projection.fromLatLngToPoint(chicago);
				  var pixelCoordinate = new google.maps.Point(
					  worldCoordinate.x * numTiles,
					  worldCoordinate.y * numTiles);
				  var tileCoordinate = new google.maps.Point(
					  Math.floor(pixelCoordinate.x / TILE_SIZE),
					  Math.floor(pixelCoordinate.y / TILE_SIZE));

				  return [
					chicago.lat() + ',' + chicago.lng(),
					worldCoordinate.x + ',' + worldCoordinate.y,
					Math.floor(pixelCoordinate.x) + ',' + Math.floor(pixelCoordinate.y),
					tileCoordinate.x + ',' + tileCoordinate.y
				  ];
				}
				
				details = createInfoWindowContent();
				return details;
				// 0 => Geo, 1 => world, 2 => pixel, 3 => tile
		}
		
		
		
		function compile_tile_coordinates() {
			
			// First of all, read all image files filenames from the server.
			var url = 'http://127.0.0.1/uav/tiles/tiles-list.html';
			var data = $.ajax({
						url:  url,
						dataType: "json", 
						async: false
					}); // This will wait until you get a response from the ajax request.
			
			list = data.responseText.split(';');
			tiles = Object();
			// Loop through each filename, read the geo coordinates, convert it to world coordinates.
			for (i = 0; i < list.length; i++) {
				coords = list[i];
				coords = coords.split(';')[0];
				coords = coords.split(',');
				lat = coords[0].trim();
				lon = coords[1].split('.');
				lon = (lon[0] + '.' + lon[1]).trim();
				tile = geo_to_tile(lat, lon)[3];
				//tile = tile.split(',');
				//tiles[lat + ',' + lon] = tile
				tiles[tile] = [lat, lon];
			}
			return tiles;
		}
		
		tileFunction = function get_tile_url(p, z) {
			tiles = compile_tile_coordinates();
			//console.log(tiles);
			/*
			 * z holds the current zoom level.
			 * p holds current  world coordinates.
			 *
			 */
			world = p.x + ',' + p.y;
			tile = tiles[world];
			console.log(tile);
			console.log(world);
			return "http://127.0.0.1/uav/tiles/tiles/tiles/" + tile + ".png";
			return "http://127.0.0.1/uav/custom/tiles/" + img_base + "/" + z + "/" + p.x + "-" + p.y + ".jpg";
		}
		
		
		var img_base = 'map';
			
		myTileURL = tileFunction;
		
		var uavMapTypeOptions = {
			getTileUrl: myTileURL,
			tileSize: new google.maps.Size(256, 256),
			maxZoom: 30,
			minZoom: 0,
			radius: 50,
			name: 'UAV Map'
		};

		var uavMapType = new google.maps.ImageMapType(uavMapTypeOptions);

		function initialize() {
			var myLatlng = new google.maps.LatLng(42.3544, -71.0946);
			var mapOptions = {
				center: myLatlng,
				zoom: 15,
				streetViewControl: false,
				mapTypeControlOptions: {
					mapTypeIds: ['UAV Map',  google.maps.MapTypeId.SATELLITE],
					style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
				}
			};

			map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
			
			 google.maps.event.addListener(map, 'maptypeid_changed', function() {
				var showStreetViewControl = map.getMapTypeId() != 'coordinate';
				map.setOptions({'streetViewControl': showStreetViewControl});
			  });

			  // Now attach the coordinate map type to the map's registry
			  map.mapTypes.set('UAV Map', uavMapType);
			
			
			map.mapTypes.set('UAV Map', uavMapType);
			map.setMapTypeId('UAV Map');
			
			// Overlay
			var imgURL = 'http://www.aashishtripathee.com/wp-content/uploads/2014/01/hyper.png';			
			var imageBounds = new google.maps.LatLngBounds(
									  new google.maps.LatLng(42.3481, -71.106),
									  new google.maps.LatLng(42.3605, -71.0835)
								);
			historicalOverlay = new google.maps.GroundOverlay(imgURL, imageBounds);
			
		}

		google.maps.event.addDomListener(window, 'load', initialize);
		
	</script>

</body>
</html>
